// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String                  @id
  email                 String                  @unique
  name                  String?
  emailVerified         Boolean                 @default(false)
  image                 String?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @default(now()) @updatedAt
  sessions              Session[]
  accounts              Account[]
  Composition           Composition[]
  CompositionCompletion CompositionCompletion[]
  CompositionProgress   CompositionProgress[]
  CompositionFavorite   CompositionFavorite[]
  CompositionReaction   CompositionReaction[]
  notifications         Notification[]
  kanbanTasks          KanbanTask[]
  points               UserPoint[]
  userBadges           UserBadge[]

  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@map("verification")
}

model Composition {
  id          String                  @id @default(cuid())
  title       String
  description String?
  difficulty  Difficulty              @default(MEDIUM)
  tags        String[]                @default([])
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @default(now()) @updatedAt
  createdById String?
  createdBy   User?                   @relation(fields: [createdById], references: [id])
  completions CompositionCompletion[]
  progresses  CompositionProgress[]
  favorites   CompositionFavorite[]
  reactions   CompositionReaction[]

  @@map("composition")
}

/// Records that a user completed at least one composition on a specific day (Asia/Kolkata).
model CompositionCompletion {
  id            String       @id @default(cuid())
  userId        String
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  compositionId String?
  composition   Composition? @relation(fields: [compositionId], references: [id])
  /// YYYY-MM-DD string for the day in Asia/Kolkata timezone
  dateKey       String
  completedAt   DateTime     @default(now())

  @@unique([userId, dateKey])
  @@index([userId, dateKey])
  @@map("composition_completion")
}

/// Track per-user progress on compositions (Solved/Attempting/Unsolved)
model CompositionProgress {
  id            String         @id @default(cuid())
  userId        String
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  compositionId String
  composition   Composition    @relation(fields: [compositionId], references: [id])
  status        ProgressStatus
  updatedAt     DateTime       @default(now()) @updatedAt

  @@unique([userId, compositionId])
  @@index([userId, status])
  @@map("composition_progress")
}

/// Track user favorites for compositions
model CompositionFavorite {
  id            String      @id @default(cuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  compositionId String
  composition   Composition @relation(fields: [compositionId], references: [id], onDelete: Cascade)
  createdAt     DateTime    @default(now())

  @@unique([userId, compositionId])
  @@index([userId])
  @@index([compositionId])
  @@map("composition_favorite")
}

/// Track user reactions (like/dislike) for compositions
model CompositionReaction {
  id            String       @id @default(cuid())
  userId        String
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  compositionId String
  composition   Composition  @relation(fields: [compositionId], references: [id], onDelete: Cascade)
  value         ReactionType
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@unique([userId, compositionId])
  @@index([compositionId, value])
  @@index([userId])
  @@map("composition_reaction")
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum ProgressStatus {
  SOLVED
  ATTEMPTING
  UNSOLVED
}

enum ReactionType {
  LIKE
  DISLIKE
}

/// User notifications for real-time updates
model Notification {
  id        String           @id @default(cuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      NotificationType
  title     String
  message   String
  category  NotificationCategory
  isRead    Boolean          @default(false)
  metadata  Json?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @default(now()) @updatedAt

  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@index([userId, category])
  @@map("notification")
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
}

enum NotificationCategory {
  SYSTEM
  USER
  COMPOSITION
}

/// Kanban board tasks for user workflow management
model KanbanTask {
  id        String        @id @default(cuid())
  userId    String
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String
  description String?
  status    KanbanStatus  @default(SOURCED)
  order     Int           @default(0)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @default(now()) @updatedAt

  @@index([userId, status])
  @@index([userId, order])
  @@map("kanban_task")
}

enum KanbanStatus {
  SOURCED
  IN_PROGRESS
  INTERVIEW
}

/// User points system for gamification
model UserPoint {
  id          String      @id @default(cuid())
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  points      Int
  reason      String      // e.g., "Completed composition", "Daily streak", etc.
  category    PointCategory
  metadata    Json?       // Additional data like compositionId, difficulty, etc.
  createdAt   DateTime    @default(now())

  @@index([userId, createdAt])
  @@index([userId, category])
  @@map("user_point")
}

enum PointCategory {
  COMPOSITION_COMPLETE
  DAILY_STREAK
  WEEKLY_STREAK
  MONTHLY_STREAK
  FIRST_COMPLETION
  DIFFICULTY_BONUS
  ACHIEVEMENT
}

/// Badge system for gamification
model Badge {
  id          String      @id @default(cuid())
  name        String      @unique
  description String
  icon        String?     // Icon name or URL
  criteria    Json        // Badge criteria (e.g., { type: "compositions_completed", count: 5 })
  tier        BadgeTier   @default(BRONZE)
  category    BadgeCategory
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @default(now()) @updatedAt
  userBadges  UserBadge[]

  @@map("badge")
}

/// User's badge progress and achievements
model UserBadge {
  id          String      @id @default(cuid())
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  badgeId     String
  badge       Badge       @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  isEarned    Boolean     @default(false)
  progress    Int         @default(0) // Current progress towards badge
  earnedAt    DateTime?   // When the badge was earned
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @default(now()) @updatedAt

  @@unique([userId, badgeId])
  @@index([userId])
  @@index([badgeId])
  @@map("user_badge")
}

enum BadgeTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

enum BadgeCategory {
  COMPOSITION
  ENGAGEMENT
  STREAK
  ACHIEVEMENT
}
